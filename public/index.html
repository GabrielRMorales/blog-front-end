<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog-Front End</title>
    <style>
        #register-or-login-form {
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #register-form { 
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #login-form {
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        
    </style>
</head>
<body></body>
    <main id="blog-site">
        <!-- include skeleton layout, like register buttons-->
        <form id="register-or-login-form">
            <div id="close-register-login" class="close-form">X</div>
            <div id="register-login-errors"></div>
            <label for="username-register">Register or Login</label>
            <input type="email" id="username-register-or-login" name="username" />
            <input type="submit" />
        </form>
        <form id="login-form">
            <div class="close-form">X</div>
            <div id="login-errors"></div>
            <label for="username-login">Email:</label>
            <input type="email" id="username-login" name="username" />
            <label for="password-login">Password:</label>
            <input type="password" id="password-login" name="password"  />
            <input type="submit" />
        </form>
        <form id="register-form">
            <div class="close-form">X</div>
            <div id="register-errors"></div>
            <label for="username-register">Email:</label>
            <input type="email" id="username-register" name="username" />
            <label for="usertag" name="usertag" >User tag</label>
            <input type="string" id="usertag-register" />
            <label for="password-register">Password:</label>
            <input type="password" id="password-register" name="password" />
            <label for="password2-register">Confirm Password:</label>
            <input type="password" id="password2-register" name="password2" />
            <input type="submit" />
        </form>

       
    </main>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
const URL = "http://localhost:3000";
     //-GET published posts (shortened)
const getPosts = async (url)=>{
        let postData = await fetch(url);
        return await postData.json();
    }
const postLayout=(postData)=>{
    let postContainer = document.createElement("section");
                postContainer.className = "post-container";
                let postTitle = document.createElement("h2");
                postTitle.innerText = postData.title;
                postContainer.appendChild(postTitle);
                let postText=document.createElement("p");
                postText.innerText = postData.text;
                postContainer.appendChild(postText);

                    //show whether publsihed or unpbulished
                    //include edit button
                    //include delete button
        return postContainer;
}
const addPostButton = (usr)=>{
    let postButton = document.createElement("button");
//if user is NOT admin 
    if (usr!==null && !usr.admin) {           
        postButton.innerText = "Log in to Post";
            postButton.addEventListener("click",function(){
                const form = document.getElementById("register-or-login-form");
                form.style.display = "block";
            });
                        
    } 
    else if (usr!==null && user.admin) {
        postButton.innerText = "Add New Post";
        postButton.addEventListener("click", function(){
            //show create post form
    let addPostForm = '<form id="create-post"><div class="close-form">X</div><div id="post-form-errors"></div><label for="post-title">Title:</label><input type="text" id="post-title" name="title" /><textarea id="post-text" name="text" form="create-post"><input type="submit" value="Post"></form>';
            //close form button    

                    addPostForm.addEventListener("submit",function(e){
                        e.preventDefault();
                                    //fetch post request to /posts using form id data
                        fetch(URL+"/posts", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                title: document.getElementById("post-title").value,
                                text: document.getElementById("post-text").value
                            })
                        }).then(data=>data.json())
                        .then(data=>console.log(data))
                        .catch(err=>console.log(err));
                        //if successful, add new post to page and remove #create-post form
                        //if failure, add errors to #post-form-errors
                    })  
        })                    
    }
                //prepend postButton to #blog-site
                //CHANGE postContainer.appendChild(postButton);
        
}
const displayPosts=({user, results})=>{
    
     results.forEach((p)=>{
        let el = postLayout(p)
            document.getElementById("blog-site").appendChild(el);
        //end forEach 
     });
    addPostButton(user);

}
        //-Click on a post to see all of it (accordion style) + comments  + “Log in to Post”/“Log in to comment” button

   
    //set Event listeners
    //make thse into a single configurable function-OR set the close-form class to close-display none
        let form=document.getElementById("close-register-login");
        form.addEventListener("click",function(){
            document.getElementById("register-or-login-form").style.display="none";
        });
        
        //set eventlistener for register/login form-should send fetch request
        document.getElementById("login-form").addEventListener("submit",function(e){
            e.preventDefault();
           fetch(URL+"/login", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },          
                body: JSON.stringify({
                    username: document.getElementById("username-login").value,
                    password: document.getElementById("password-login").value
                })
            }).then(data=>data.json())
            .then((data)=>{ 
                if (data.token){
                    localStorage.setItem("token", data.token);
                    document.getElementById("login-form").style.display = "none";
                } else {
                    document.getElementById("login-errors").innerText = data.message;                    
                }            
                
            }).catch(err=>console.error('There has been a problem with your fetch operation:', err));

        });

        document.getElementById("register-form").addEventListener("submit",function(e){
            e.preventDefault();
            fetch(URL + "/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: document.getElementById("username-register").value,
                    usertag: document.getElementById("usertag-register").value,
                    password: document.getElementById("password-register").value,
                    password2: document.getElementById("password2-register").value
                })
            }).then(data=>data.json())
            .then(data=>{
                if (!data.success){
                    let messages = document.getElementById("register-errors");
                    messages.innerHTML="<p>Errors:</p>";
                    if (data.errors){
                            data.errors.forEach(err=>{
                                messages.innerHTML+=`<li>${err.msg}</li>`;
                            })                        
                    }
                } else if (data.success===true){
                    //delete all values from form or should dom removal delete them?
                    document.getElementById("register-form").style.display = "none";
                    document.getElementById("login-form").style.display = "block";
                    
                }
            })
            .catch(err=>console.error('There has been a problem with your fetch operation:', err));

        })

    document.getElementById("register-or-login-form").addEventListener("submit",async function(e){
            e.preventDefault();
            //change to params:id
            let username=document.getElementById("username-register-or-login").value
            try {
                let data = await fetch(URL+"/register/"+username);
                data = await data.json();
                setNewForm(data);
            }
           catch (error) {
            console.log(data);
            document.getElementById("register-login-errors").innerText = error;
           }
            
    });
   
    function setNewForm({registered}){
        if (registered){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("login-form").style.display = "block"
        } else if (registered===false){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("register-form").style.display = "block";
        }
    }
 
    //with fetch get a promise back and based on whether the response if true/false, build a certain form
    
    //if uthere's no authneticaton token
    if (!localStorage.getItem("token")){
        getPosts(URL).then(data=>displayPosts(data));
    } 
      //else if user is logged in
    else if (localStorage.getItem("token")){
        getPosts(URL+"/posts").then(data=>displayPosts(data));
    }
  

    </script>
</body>
</html>