<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog-Front End</title>
    <style>
        #register-or-login-form {
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #register-form { 
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #login-form {
            /*display: none;*/
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        
    </style>
</head>
<body>
    <main>
        <form id="register-or-login-form">
            <div id="close-register-login" class="close-form">X</div>
            <label for="username-register">Register or Login</label>
            <input type="email" id="username-register-or-login" name="username" />
            <input type="submit" />
        </form>
        <form id="login-form">
            <div class="close-form">X</div>
            <label for="username-login">Email:</label>
            <input type="email" id="username-login" name="username" placeholder="gman@gmail.com" />
            <label for="password-login">Password:</label>
            <input type="password" id="password-login" name="password" placeholder="retard77" />
            <input type="submit" />
        </form>
        <form id="register-form">
            <div class="close-form">X</div>
            <label for="username-register">Email:</label>
            <input type="email" id="username-register" name="username" />
            <label for="usertag" name="usertag" >User tag</label>
            <input type="string" id="usertag-register" />
            <label for="password-register">Password:</label>
            <input type="password" id="password-register" name="password" />
            <label for="password2-register">Confirm Password:</label>
            <input type="password" id="password2-register" name="password2" />
            <input type="submit" />

        </form>
    </main>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">

     //-GET published posts (shortened)
    const getPosts = async ()=>{
        let postData = await fetch("http://localhost:3000");
        postData = await postData.json();
        return postData;
    }
    const displayPosts=(posts, target=document.getElementsByTagName("main")[0], loggedIn=false)=>{
        posts.then(postData=>{
            postData.forEach(p=>{
                let postContainer = document.createElement("section");
                postContainer.className = "post-container";
                let postTitle = document.createElement("h2");
                postTitle.innerText = p.title;
                postContainer.appendChild(postTitle);
                let postText=document.createElement("p");
                postText.innerText = p.text;
                postContainer.appendChild(postText);
                let postButton;
                if (loggedIn===false){
                    postButton = document.createElement("button");
                    postButton.innerText = "Log in to Post";
                    postButton.addEventListener("click",function(){
                        const form = document.getElementById("register-or-login-form");
                        form.style.display = "block";
                    });
                    postContainer.appendChild(postButton);
                }
                target.appendChild(postContainer);
            }); 
        })
              
    }

    displayPosts(getPosts());
//make thse into a single configurable function-OR set the close-form class to close-display none
        let form=document.getElementById("close-register-login");
        form.addEventListener("click",function(){
            document.getElementById("register-or-login-form").style.display="none";
        });
        
        document.getElementById("login-form").addEventListener("submit",async function(e){
            e.preventDefault();
           fetch("http://localhost:3000/login", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },          
                body: JSON.stringify({
                    username: "gman@gmail.com",
                    password: "retard77"
                })
            }).then(({user, token})=>{
                console.log(token);

            })
            .catch(err=>console.log(err));

        //                 $.ajax({
        //                     type: "POST",
        //                     url: "http://localhost:3000/login",
        //                     data: {
        //                         username: "gman@gmail.com",
        //                         password: "retard77"
        //                     }
        //                 }).then(data=>console.log(data))
        // .catch(err=>console.log(err));


        });

        //-Click on a post to see all of it (accordion style) + comments  + “Log in to Post”/“Log in to comment” button

    //set eventlistener for register/login form-should send fetch request
    //with fetch get a promise back and based on whether the response if true/false, build a certain form
    function registerOrLogin(){
        document.getElementById("register-or-login-form").addEventListener("submit",async function(e){
            e.preventDefault();
            //change to params:id
            let username=document.getElementById("username-register-or-login").value
            let data = await fetch("http://localhost:3000/register/"+username);
            data = await data.json();
            setNewForm(data);
        });
    }
    function setNewForm({registered}){
        if (registered){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("login-form").style.display = "block"
        } else if (registered===false){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("register-form").style.display = "block";
        }
    }
    registerOrLogin();

    </script>
</body>
</html>