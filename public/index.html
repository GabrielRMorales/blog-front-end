<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog-Front End</title>
    <style>
        #register-or-login-form {
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #register-form { 
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        #login-form {
            display: none;
            position: absolute;
            top: 300px;
            left: 300px;
            opacity: .5;
        }
        section,.comment {
            border: 1px solid black;
            padding: 10px;
        }
        
    </style>
</head>
<body></body>
    <header>
        <button id="logout">Logout</button>
    </header>
    <main id="blog-site">
        <!-- include skeleton layout, like register buttons-->
        <form id="register-or-login-form">
            <div id="close-register-login" class="close-form">X</div>
            <div id="register-login-errors"></div>
            <label for="username-register">Register or Login</label>
            <input type="email" id="username-register-or-login" name="username" />
            <input type="submit" />
        </form>
        <form id="login-form">
            <div class="close-form">X</div>
            <div id="login-errors"></div>
            <label for="username-login">Email:</label>
            <input type="email" id="username-login" name="username" />
            <label for="password-login">Password:</label>
            <input type="password" id="password-login" name="password"  />
            <input type="submit" />
        </form>
        <form id="register-form">
            <div class="close-form">X</div>
            <div id="register-errors"></div>
            <label for="username-register">Email:</label>
            <input type="email" id="username-register" name="username" />
            <label for="usertag" name="usertag" >User tag</label>
            <input type="string" id="usertag-register" />
            <label for="password-register">Password:</label>
            <input type="password" id="password-register" name="password" />
            <label for="password2-register">Confirm Password:</label>
            <input type="password" id="password2-register" name="password2" />
            <input type="submit" />
        </form>

       
    </main>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
//new posts don't show reply buttons
//make sure the edit commnets/post don't replace the child so much as edit the text upon updating

//edit commet form shouldn't replace text?

//doesn't logout properly-fix all the login stuff


//maybe these are due to being logged out??
//can't edit posts!!
//can't add comment!

//show errors
//the pre-register/login form bugs...ie duplicate forms

//refactor it as needed!
//stylize it!

const URL = "http://localhost:3000";

     //-GET published posts (shortened)
const getPosts = async (url)=>{
        let postData = await fetch(url);
        return await postData.json();
    }

const deletePostButton = ()=>{
    let btn = document.createElement("button");
    btn.className = "delete-post-btn";
    btn.innerText = "Delete Post";
    btn.addEventListener("click",function(e){
        //remember this needs a confirmation passthrough
        //could be its own deleteButtonForm function
        e.preventDefault();
        let post =  e.target.parentNode;
        let btnId = post.id;
       fetch(URL+"/posts/delete/"+btnId, 
        {method: "DELETE",
        headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`
        }
        }).then(data=>data.json())
        .then(data=>{
            if (data.deleted===true){
                //delete from page
                post.parentNode.removeChild(post);
            }
        });

    });
    return btn;
}
const postLayout=(postData)=>{
    let postContainer = document.createElement("section");   
    postContainer.className = "post-container";
    let postTitle = document.createElement("h2")
    postTitle.innerText = postData.title;
    postTitle.className = "post-title";
    postContainer.appendChild(postTitle);
    let postText=document.createElement("p");
    postText.innerText = postData.text;
    postText.className = "post-text";
    postContainer.appendChild(postText);
    let postStatus = document.createElement("p");
    postStatus.innerText = postData.published ? "published" : "unpublished" ;
    postStatus.className = "post-status";
    postContainer.appendChild(postStatus);   
    let postControls = document.createElement("section");
    postControls.className="post-controls";
    postContainer.appendChild(postControls);
    postContainer.id = postData._id;
   
    return postContainer;
}
const editPostForm = (title, text, published)=>{
     
    let form = document.createElement("form");
    //edit form needs a close btn too
    form.className = "edit-post-form";
    form.innerHTML+="<div class='close-form' >X</div>";
    form.innerHTML+="<label for='edit-form-title'>Title:</label>";
    form.innerHTML+=`<input type='text' class='edit-form-title' value='${title}' name='title' />`
    form.innerHTML+="<label for='edit-form-text'>Text:</label>";
    form.innerHTML+=`<input type='text' class='edit-form-text' value='${text}' name='text' />`
    form.innerHTML+=`<input type="radio" name="post-status" class="edit-form-published" ${published ==="published"? "checked" : ""}>`;
    form.innerHTML+="<label for='edit-form-published'>Published</label>"
    form.innerHTML+=`<input type="radio" name="post-status" class="edit-form-unpublished" ${published ==="unpublished"? "checked" : "" }>`;
    form.innerHTML+="<label for='edit-form-unpublished'>Unpublished</label>"
    form.innerHTML+="<input type='submit' class='update-post-btn' value='Update Post' />"
    form.querySelector(".close-form").addEventListener("click",function(e){             
        e.target.parentNode.parentNode.removeChild(e.target.parentNode);
    });
    return form;
}
const editPostButton = ()=>{
    let btn = document.createElement("button");
    btn.className = "edit-post-btn";
    btn.innerText = "Edit Post";
    //addeventlistener based on id
    btn.addEventListener("click",function(e){
        let targetEl = document.getElementById(e.target.parentNode.parentNode.id);     
        let title, text, published;
        [title, text, published] = [targetEl.querySelector(".post-title").innerText,
        targetEl.querySelector(".post-text").innerText, targetEl.querySelector(".post-status").innerText];
        //targetEl.innerHTML = ""; should maintain comments while updating
        if (!targetEl.querySelector(".post-controls").querySelector(".edit-post-form")){
            targetEl.querySelector(".post-controls").appendChild(editPostForm(title, text, published));
        }
       
        targetEl.querySelector(".edit-post-form").addEventListener("submit",function(e){
            e.preventDefault();
            //close form
            //send put request
            
            let title= targetEl.querySelector(".edit-form-title").value;
            let text = targetEl.querySelector(".edit-form-text").value;
            let published = targetEl.querySelector("input[name='post-status']:checked").value;
            let postId = e.target.parentNode.id;
           fetch(URL+"/posts/edit/"+e.target.parentNode.id, {
                method: "PUT",
                headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}` },
                body: JSON.stringify({ title, text, published})
            }).then(data=>data.json())
            .then(data=>{
                //if err send back
                //
                //should maintain comments after updating
                console.log(data);                
                //update post DOM
                targetEl.parentNode.replaceChild(postLayout(data), targetEl);
                //needs to add reply buttons
                console.log(targetEl);
                let updatedPost = document.getElementById(data._id);
                updatedPost.appendChild(editPostButton());
                updatedPost.appendChild(deletePostButton());

            }).catch(err=>console.log(err));
                        
        })
    });
    

   return btn;

}

const addPostForm=()=>{

    let form = document.createElement("form");
           form.id="create-post";  
           form.innerHTML+='<div class="close-form">X</div><div id="post-form-errors"></div><label for="post-title">Title:</label><input type="text" id="post-title" name="title" /><input type="submit" value="Post"><textarea id="post-text" name="text" form="create-post" />';

           form.addEventListener("submit",function(e){
                e.preventDefault();
                //fetch post request to /posts using form id data
                fetch(URL+"/posts", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    body: JSON.stringify({
                        title: document.getElementById("post-title").value,
                        text: document.getElementById("post-text").value
                    })
                }).then(data=>data.json())
                .then(data=>{
                    console.log(data)
                    //if successful, add new post to page and remove #create-post form
                    let el = postLayout(data);
                    document.getElementById("blog-site").appendChild(el);
                    e.target.parentNode.removeChild(e.target);
                    let controls = el.querySelector(".post-controls")
                    controls.appendChild(newCommentButton());
                    controls.appendChild(editPostButton());
                    controls.appendChild(deletePostButton());

                    //if failure, add errors to #post-form-errors
                })
                .catch(err=>console.log(err));
            })
            form.querySelector(".close-form").addEventListener("click",function(e){     
                e.target.parentNode.parentNode.removeChild(e.target.parentNode);
            });

    return form;
}

const newPostButton = (authenticationCode)=>{

    let postButton = document.createElement("button");
    let siteChild = document.getElementById("blog-site").firstChild;
    siteChild.parentNode.insertBefore(postButton, siteChild);
//if user is NOT admin    
if (authenticationCode===2) {
    postButton.innerText = "Add New Post";
    postButton.addEventListener("click", function(e){
        //show create post form
        if (!e.target.parentNode.querySelector("#create-post")){
            let newForm = addPostForm();        
            postButton.after(newForm);
        }
        
    })                    
    } else {
        postButton.innerText = "Log in to Post";
            postButton.addEventListener("click",function(){
                const form = document.getElementById("register-or-login-form");
                form.style.display = "block";
        });
                        
    }   
        
}

const getComments = async (url)=>{
    let commentData = await fetch(url+"/comments");
    return await commentData.json();
}
//alter depending on return value of get posts?
const sortComments = (comments, post)=>{
    if (comments){
        return comments.filter(c=>c.post===post._id)

    }
  
}

const deleteCommentButton = ()=>{
    let btn = document.createElement("button");
    btn.innerHTML="Delete this comment";
    btn.addEventListener("click", function(e){
        commentId=e.target.parentNode.id;
        //fetch delete request
        fetch(URL+"/comments/delete/"+commentId,{
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        }).then(data=>data.json())
        .then(data=>{
            if (data.deleted===true){
                let el=document.getElementById(commentId)
                el.parentNode.removeChild(el);
            }
        })
        .catch(err=>console.log(err));

    });
    return btn;
}
const addCommentForm = (postId)=>{
    let form = document.createElement("form");
    form.classList.add("add-comment-form")
    form.innerHTML+=`<div class="close-form">X</div><button type='submit'>Add Comment</button><textarea id='${postId}-comment' name='commentText' class='comment-text'  />`
    
    form.addEventListener("submit", function(e){
        e.preventDefault();                
        fetch(URL+"/comments", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify({
                text: document.getElementById(postId+"-comment").value,
                postId: postId
            })
        }).then(data=>data.json())
        .then(comment=>{
            e.target.parentNode.appendChild(commentLayout(comment));
            e.target.parentNode.removeChild(e.target);
            
        })
        .catch(err=>console.log(err));
        
    })
    //addCommentForm also needs a close button to cancel
    form.querySelector(".close-form").addEventListener("click",function(e){             
        e.target.parentNode.parentNode.removeChild(e.target.parentNode);
    });
    return form
    
    
}
const newCommentButton = (authenticationCode)=>{
    let commentButton = document.createElement("button");
    if (authenticationCode===2){
        commentButton.innerText = "Reply";
        commentButton.addEventListener("click",function(e){
            let postId=e.target.parentNode.id;
            if (!e.target.parentNode.parentNode.querySelector(".add-comment-form")){
                e.target.parentNode.after(addCommentForm(postId));
            }
        });
    }
    else {
        //log in to reply
        commentButton.innerText="Login To Reply";
        commentButton.addEventListener("click",function(e){
            document.getElementById("register-or-login-form").style.display="block";
            //add here
        })
    }

    return commentButton;

}

const editCommentForm = (commentId, commentText)=>{
    let form = document.createElement("form");
    console.log(`comment Text ${commentText}`);
    form.innerHTML+=`<div class="close-form">X</div><button type='submit' >Update Comment</button><textarea id='${commentId}-edit-text' name='edit-comment-text' className='edit-comment-form' >${commentText}</textarea>`
  
    form.addEventListener("submit", function(e){
        e.preventDefault();
        console.log();
        let newInput = document.getElementById(`${commentId}-edit-text`).value;

        fetch(URL+"/comments/edit/"+commentId, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify({
                text: newInput,
                post: document.getElementById(commentId).parentNode.parentNode.id
            })
       
        }).then(data=>data.json()) 
            .then(data=>{console.log(data)
            let newComment = document.createElement("h3")
            newComment.innerText = data.text;
            let comment = document.getElementById(commentId);
            comment.replaceChild(newComment, form)
            // include an edited by user.name-this would require adding the field to the database   
            /*let editNote = document.createElement("p");
            editNote.innerText = `Edited by ${data.editingUser}`;   
            comment.appendChild(editNote);*/
            })
            .catch(err=>{console.log(err)
                form.appendChild("There was an error!");
            });        

    })
    form.querySelector(".close-form").addEventListener("click",function(e){             
        e.target.parentNode.parentNode.removeChild(e.target.parentNode);
    });
    return form;
}

const editCommentButton = (comment)=>{
    
    let btn=document.createElement("button");
    btn.innerText = "Edit Comment";

    btn.addEventListener("click", function(e){
        let commentId = comment.id;
        let commentText = comment.querySelector("h3");     
       e.target.parentNode.replaceChild(editCommentForm(commentId, commentText.innerText), commentText);

    });
    return btn;
}

const commentLayout = (comment)=>{
    let commContainer = document.createElement("div");
    commContainer.className = "comment";
    commContainer.id=`${comment._id}`;
    commContainer.innerHTML+=`<p>${comment.user.usertag}:</p>`;
    commContainer.innerHTML+=`<h3>${comment.text}</h3>`;   
    commContainer.appendChild(deleteCommentButton());
    commContainer.appendChild(editCommentButton(commContainer));
    return commContainer;
}

const displayPosts=({authenticationCode, results}, commentArr)=>{
    results.forEach((p)=>{
        let el = postLayout(p);
      //addComment 
      let controls = el.querySelector(".post-controls");
      controls.appendChild(newCommentButton(authenticationCode));
     //include edit button
     controls.appendChild(editPostButton());
     //include delete button
     controls.appendChild(deletePostButton());
     //add in comments
        //commentArr
      let commentList = sortComments(commentArr, p);
      commentList.forEach(comment=>{
          el.appendChild(commentLayout(comment));        
      })
      
      document.getElementById("blog-site").appendChild(el);
     });
     newPostButton(authenticationCode);
    
}
        //-Click on a post to see all of it (accordion style) + comments  + “Log in to Post”/“Log in to comment” button

   
//set Event listeners
//make thse into a single configurable function-OR set the close-form class to close-display none
        let form=document.getElementById("close-register-login");
        form.addEventListener("click",function(){
            document.getElementById("register-or-login-form").style.display="none";
        });
        
        //set eventlistener for register/login form-should send fetch request
        document.getElementById("login-form").addEventListener("submit",function(e){
            e.preventDefault();
           fetch(URL+"/login", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },          
                body: JSON.stringify({
                    username: document.getElementById("username-login").value,
                    password: document.getElementById("password-login").value
                })
            }).then(data=>data.json())
            .then((data)=>{ 
                if (data.token){
                    localStorage.setItem("token", data.token);
                    document.getElementById("login-form").style.display = "none";
                    //now what?
                    renderPage();
                } else {
                    document.getElementById("login-errors").innerText = data.message;                    
                }            
                
            }).catch(err=>console.error('There has been a problem with your fetch operation:', err));

        });

        document.getElementById("register-form").addEventListener("submit",function(e){
            e.preventDefault();
            fetch(URL + "/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: document.getElementById("username-register").value,
                    usertag: document.getElementById("usertag-register").value,
                    password: document.getElementById("password-register").value,
                    password2: document.getElementById("password2-register").value
                })
            }).then(data=>data.json())
            .then(data=>{
                if (!data.success){
                    let messages = document.getElementById("register-errors");
                    messages.innerHTML="<p>Errors:</p>";
                    if (data.errors){
                            data.errors.forEach(err=>{
                                messages.innerHTML+=`<li>${err.msg}</li>`;
                            })                        
                    }
                } else if (data.success===true){
                    //delete all values from form or should dom removal delete them?
                    document.getElementById("register-form").style.display = "none";
                    document.getElementById("login-form").style.display = "block";
                    
                }
            })
            .catch(err=>console.error('There has been a problem with your fetch operation:', err));

        })

    document.getElementById("register-or-login-form").addEventListener("submit",async function(e){
            e.preventDefault();
            //change to params:id
            let username=document.getElementById("username-register-or-login").value
            try {
                let data = await fetch(URL+"/register/"+username);
                data = await data.json();
                setNewForm(data);
            }
           catch (error) {
            console.log(error);
            document.getElementById("register-login-errors").innerText = error;
           }
            
    });
   document.getElementById("logout").addEventListener("click",(e)=>{
       fetch(URL+"/logout").then(data=>{
           //this won't work as you think-it just appends the intializing data
           renderPage();
       })
   })
    function setNewForm({registered}){
        if (registered){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("login-form").style.display = "block"
        } else if (registered===false){
            document.getElementById("register-or-login-form").style.display = "none";
            document.getElementById("register-form").style.display = "block";
        }
    }
 function getData(path){
    return fetch(URL+path,{
            method: "GET",
            headers: {
    "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
            //data.json returns an unresolved promise, promise.resolve or promise.all would return a resolved promise
            //this resolved prmise can be used
        }).then(data=>data.json());
}

    //with fetch get a promise back and based on whether the response if true/false, build a certain form
    
    //if there's no authneticaton token
function renderPage(){
    if (!localStorage.getItem("token")){
        //fix error here after
        Promise.all([getPosts(URL), getComments(URL)]).then(values=>{
            displayPosts(values[0], values[1]);
        }).catch(err=>console.log(err));
    } 
      //else if user is logged in
    else if (localStorage.getItem("token")){
        Promise.all([getData("/posts"), getData("/comments")]).then(values=>{
            displayPosts(values[0],values[1]);
        }).catch(err=>console.log(err));
    }  
}

renderPage();
</script>
</body>
</html>